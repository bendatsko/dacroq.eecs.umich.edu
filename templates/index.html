<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TeensySAT - Flynn Lab</title>
  <link rel="icon" type="image/png" href="https://i.postimg.cc/dVdXSpRc/network.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Fragment+Mono:ital@0;1&display=swap');

    body {
      font-family: 'Helvetica Neue', sans-serif;
      background-color: #ffffff;
    }
    .monospace {
      font-family: 'Fragment Mono', monospace;
    }
    .results-notification {
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
  </style>
</head>
<body class="min-h-screen bg-white text-gray-900">
  <div class="max-w-4xl mx-auto px-4 py-12">
    <!-- Header -->
{#    <div class="mb-12">#}
{#      <h1 class="text-4xl font-bold text-center text-gray-900 mb-6">TeensySAT</h1>#}
{#      <div class="max-w-2xl mx-auto space-y-4">#}
{#        <div class="space-y-2 text-center">#}
{#          <p class="text-gray-700">#}
{#            Upload <code class="px-1.5 py-0.5 bg-gray-100 rounded text-sm monospace">.cnf</code> file in DIMACS format#}
{#          </p>#}
{#          <p class="text-gray-700">#}
{#            Upload <code class="px-1.5 py-0.5 bg-gray-100 rounded text-sm monospace">.zip</code> file containing multiple instances#}
{#          </p>#}
{#          <p class="text-gray-700">#}
{#            Select from benchmark test library#}
{#          </p>#}
{#        </div>#}
{#      </div>#}
{#    </div>#}

    <!-- Main Content -->
    <div class="space-y-8">
      <!-- Input Mode Selection -->
      <div class="border-b border-gray-200">
        <nav class="flex justify-center -mb-px">
          <button id="toggle-file-upload" class="px-6 py-3 border-b-2 border-gray-900 text-sm font-medium">
            File Upload
          </button>
          <button id="toggle-text-input" class="px-6 py-3 border-b-2 border-transparent text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300">
            Text Input
          </button>
          <button id="toggle-dataset" class="px-6 py-3 border-b-2 border-transparent text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300">
            Test Dataset
          </button>
        </nav>
      </div>

      <!-- File Upload Section -->
      <div id="file-upload-section">
        <div class="border-2 border-dashed border-gray-300 rounded-lg">
          <div id="drop-zone" class="px-6 py-10 text-center cursor-pointer hover:bg-gray-50">
            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
            </svg>
            <p class="mt-2 text-sm text-gray-600">Drop your files here or click to select</p>
            <div id="selected-files" class="mt-2 text-sm text-gray-500"></div>
          </div>
        </div>
        <input id="file-input" type="file" multiple class="hidden" accept=".cnf,.zip" />
      </div>

      <!-- Text Input Section -->
      <div id="text-input-section" class="hidden">
        <label class="block text-sm font-medium text-gray-700 mb-2">DIMACS format:</label>
        <textarea id="cnf-text-input" rows="8" class="w-full p-3 border border-gray-300 rounded-lg monospace text-sm focus:ring-1 focus:ring-gray-900 focus:border-gray-900">
c Example 3SAT problem with 4 variables and 3 clauses
c Each line starting with 'c' is a comment
p cnf 4 3
1 2 3 0
-2 3 4 0
-1 -3 -4 0</textarea>
      </div>

      <!-- Preset Selection Section -->
      <div id="preset-section" class="hidden">
        <label class="block text-sm font-medium text-gray-700 mb-2">Select Preset:</label>
        <select id="preset-select" class="w-full p-3 border border-gray-300 rounded-lg text-sm focus:ring-1 focus:ring-gray-900 focus:border-gray-900">
          <option value="">-- Loading Presets... --</option>
        </select>
      </div>

      <!-- Run Button -->
      <button id="submit-button" class="w-full px-4 py-3 bg-black text-white text-sm font-medium rounded hover:bg-black/90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-900 disabled:opacity-50 disabled:cursor-not-allowed">
        Run Analysis
      </button>

      <!-- Email Option (Minimalist) -->
      <div class="mt-4 space-y-2">
        <div class="flex items-center">
          <input id="enable-email" type="checkbox" class="h-4 w-4 text-gray-900 focus:ring-gray-500 border-gray-300 rounded">
          <label for="enable-email" class="ml-2 block text-sm text-gray-600">
            Email me the results
          </label>
        </div>
        <div id="email-input-container" class="hidden">
          <input type="email" id="email-input" name="email" placeholder="Enter email" class="mt-1 block w-full px-3 py-2 text-sm border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-gray-900 focus:border-gray-900">
          <div class="flex items-center mt-2">
            <input id="save-email" type="checkbox" class="h-3 w-3 text-gray-600 focus:ring-gray-500 border-gray-300 rounded">
            <label for="save-email" class="ml-2 block text-xs text-gray-500">
              Remember my email
            </label>
          </div>
        </div>
      </div>

      <!-- System Status Section (Collapsible) -->
      <div class="mt-8">
        <button onclick="toggleSystemStatus()" class="w-full flex justify-between items-center p-4 bg-gray-50 border border-gray-200 rounded-lg hover:bg-gray-100 transition-colors">
          <span class="text-sm font-medium text-gray-700">System Status</span>
          <svg id="system-status-arrow" class="w-5 h-5 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
          </svg>
        </button>
        <div id="chip-state-display" class="hidden mt-2 p-4 border border-gray-200 rounded-lg bg-gray-50 text-sm font-mono">
          Loading system status...
        </div>
      </div>

      <!-- Results Section -->
      <div id="results-container" class="mt-8">
        <button onclick="toggleResults()" class="w-full flex justify-between items-center p-4 bg-gray-50 border border-gray-200 rounded-lg hover:bg-gray-100 transition-colors">
          <div class="flex items-center">
            <h3 class="text-sm font-medium text-gray-700">Results</h3>
            <span id="new-results-badge" class="hidden ml-3 px-2 py-1 text-xs font-medium bg-green-100 text-green-800 rounded-full results-notification">
              New Results
            </span>
          </div>
          <svg id="results-arrow" class="w-5 h-5 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
          </svg>
        </button>

        <div id="results-content" class="hidden mt-4 space-y-8">
          <!-- Summary Statistics -->
          <div>
            <h4 class="text-sm font-medium text-gray-700 mb-3">Summary Statistics</h4>
            <div id="summary-statistics" class="p-4 border border-gray-200 rounded-lg bg-gray-50 monospace text-sm" style="white-space: pre-wrap;">
              Loading summary statistics...
            </div>
          </div>
          
          <!-- Performance Overview -->
          <div>
            <h4 class="text-sm font-medium text-gray-700 mb-3">Performance Overview</h4>
            <div class="border border-gray-200 rounded-lg overflow-hidden">
              <img src="/performance_overview.png" alt="Performance Overview" class="w-full" id="performance-img">
            </div>
          </div>

          <!-- Download Links -->
          <div class="space-y-2">
            <a href="/sat_solver_summary.csv" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 rounded-lg border border-gray-200 flex items-center">
              <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
              </svg>
              Download Solver Summary (CSV)
            </a>
            <a href="/benchmark_data.json" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 rounded-lg border border-gray-200 flex items-center">
              <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
              </svg>
              Download Benchmark Data (JSON)
            </a>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer class="mt-12 pt-8 border-t border-gray-200">
      <p class="text-sm text-center text-gray-500">
        &copy; University of Michigan Integrated Circuits Lab. All rights reserved.
      </p>
    </footer>
  </div>

  <script>
    // Global state variables
    let droppedFiles = [];
    let currentMode = "file";
    let checkResultsInterval;
    let lastResultsTimestamp = null;

    // Initialize everything when the page loads
    document.addEventListener("DOMContentLoaded", () => {
      fetchPresets();
      setupDragAndDrop();
      setupFileInputClick();
      initializeEventListeners();
      pollChipState();
      loadInitialResults();
      setupEmailHandling();
    });


    function toggleSystemStatus() {
      const content = document.getElementById('chip-state-display');
      const arrow = document.getElementById('system-status-arrow');
      
      if (content.classList.contains('hidden')) {
        content.classList.remove('hidden');
        arrow.classList.add('rotate-180');
      } else {
        content.classList.add('hidden');
        arrow.classList.remove('rotate-180');
      }
    }

    // Load initial results
    async function loadInitialResults() {
      await loadSummaryStatistics();
      const t = new Date().getTime();
      document.getElementById('performance-img').src = `/performance_overview.png?t=${t}`;
    }

    function initializeEventListeners() {
      const fileUploadBtn = document.getElementById("toggle-file-upload");
      const textInputBtn = document.getElementById("toggle-text-input");
      const datasetBtn = document.getElementById("toggle-dataset");
      const submitBtn = document.getElementById("submit-button");
      
      fileUploadBtn.addEventListener("click", () => showSection("file"));
      textInputBtn.addEventListener("click", () => showSection("text"));
      datasetBtn.addEventListener("click", () => showSection("dataset"));
      submitBtn.addEventListener("click", handleSubmit);
    }

    function setupEmailHandling() {
  const enableEmailCheckbox = document.getElementById('enable-email');
  const emailContainer = document.getElementById('email-input-container');
  const emailInput = document.getElementById('email-input');
  const saveEmailCheckbox = document.getElementById('save-email');

  // Load saved email if it exists.
  const savedEmail = localStorage.getItem('savedEmail');
  if (savedEmail) {
    emailInput.value = savedEmail;
    saveEmailCheckbox.checked = true;
    // Also check the "Email me the results" box and show the container.
    enableEmailCheckbox.checked = true;
    emailContainer.classList.remove('hidden');
  }

  enableEmailCheckbox.addEventListener('change', (e) => {
    emailContainer.classList.toggle('hidden', !e.target.checked);
    if (!e.target.checked) {
      emailInput.value = '';
    } else if (savedEmail) {
      emailInput.value = savedEmail;
    }
  });

  saveEmailCheckbox.addEventListener('change', (e) => {
    if (e.target.checked) {
      localStorage.setItem('savedEmail', emailInput.value);
    } else {
      localStorage.removeItem('savedEmail');
    }
  });

  emailInput.addEventListener('input', (e) => {
    if (saveEmailCheckbox.checked) {
      localStorage.setItem('savedEmail', e.target.value);
    }
  });
}



    function toggleResults() {
      const content = document.getElementById('results-content');
      const arrow = document.getElementById('results-arrow');
      const badge = document.getElementById('new-results-badge');
      
      if (content.classList.contains('hidden')) {
        content.classList.remove('hidden');
        arrow.classList.add('rotate-180');
        badge.classList.add('hidden'); // Hide the badge when expanding
      } else {
        content.classList.add('hidden');
        arrow.classList.remove('rotate-180');
      }
    }

    function showNewResultsAvailable() {
      const badge = document.getElementById('new-results-badge');
      const content = document.getElementById('results-content');
      
      badge.classList.remove('hidden');
      content.classList.add('hidden'); // Ensure content starts collapsed
      document.getElementById('results-arrow').classList.remove('rotate-180');
    }

    function updateLastUpdated(timestamp) {
      const lastUpdatedEl = document.getElementById('last-updated');
      if (lastUpdatedEl) {
        lastUpdatedEl.textContent = `Last updated: ${new Date(timestamp).toLocaleString()}`;
      }
    }

    
    async function checkResultsTimestamp() {
      try {
        // Call the summary_statistics endpoint without the ?t= query string.
        const response = await fetch('/summary_statistics');
        const text = await response.text();
        const match = text.match(/Last updated: (.+)/);
        if (match && match[1]) {
          const timestamp = new Date(match[1]).getTime();
          if (lastResultsTimestamp === null || timestamp > lastResultsTimestamp) {
            lastResultsTimestamp = timestamp;
            updateLastUpdated(timestamp);
            return true;
          }
        }
        return false;
      } catch (error) {
        console.error('Error checking results timestamp:', error);
        return false;
      }
    }

    function startCheckingResults() {
      checkResultsInterval = setInterval(async () => {
        const hasNewResults = await checkResultsTimestamp();
        if (hasNewResults) {
          // Refresh the performance overview image to force an update
          const t = new Date().getTime();
          document.getElementById('performance-img').src = `/performance_overview.png?t=${t}`;
          loadSummaryStatistics();
        }
      }, 2000);
    }

    function showSection(mode) {
      currentMode = mode;
      const fileSection = document.getElementById("file-upload-section");
      const textSection = document.getElementById("text-input-section");
      const presetSection = document.getElementById("preset-section");
      
      [fileSection, textSection, presetSection].forEach(section => section.classList.add("hidden"));
      
      if (mode === "file") fileSection.classList.remove("hidden");
      if (mode === "text") textSection.classList.remove("hidden");
      if (mode === "dataset") presetSection.classList.remove("hidden");
      updateButtonStates(mode);
    }

    function updateButtonStates(activeMode) {
      const buttons = {
        file: document.getElementById("toggle-file-upload"),
        text: document.getElementById("toggle-text-input"),
        dataset: document.getElementById("toggle-dataset")
      };
      Object.entries(buttons).forEach(([mode, btn]) => {
        btn.classList.remove("border-gray-900", "text-gray-900");
        btn.classList.add("border-transparent", "text-gray-500");
      });
      buttons[activeMode].classList.remove("border-transparent", "text-gray-500");
      buttons[activeMode].classList.add("border-gray-900", "text-gray-900");
    }

    function pollChipState() {
      setInterval(() => {
        fetch("/teensysat/chip_state")
          .then(response => {
            if (!response.ok) throw new Error("Network response not OK");
            return response.text();
          })
          .then(text => {
            try {
              const data = JSON.parse(text);
              const chipStateEl = document.getElementById("chip-state-display");
              chipStateEl.textContent = JSON.stringify(data, null, 2);
            } catch (e) {
              console.error("JSON parse error in chip_state:", e);
            }
          })
          .catch(error => console.error("Error polling chip state:", error));
      }, 1000);
    }

    function setupDragAndDrop() {
      const dropZone = document.getElementById("drop-zone");
      dropZone.addEventListener("dragover", (e) => {
        e.preventDefault();
        dropZone.classList.add("bg-gray-50");
      });
      dropZone.addEventListener("dragleave", (e) => {
        e.preventDefault();
        dropZone.classList.remove("bg-gray-50");
      });
      dropZone.addEventListener("drop", (e) => {
        e.preventDefault();
        dropZone.classList.remove("bg-gray-50");
        droppedFiles = Array.from(e.dataTransfer.files);
        displaySelectedFiles(droppedFiles);
        uploadFiles(droppedFiles);
      });
      dropZone.addEventListener("click", () => {
        document.getElementById("file-input").click();
      });
    }

    function setupFileInputClick() {
      const fileInput = document.getElementById("file-input");
      fileInput.addEventListener("change", (e) => {
        droppedFiles = Array.from(fileInput.files);
        displaySelectedFiles(droppedFiles);
        uploadFiles(droppedFiles);
      });
    }

    function displaySelectedFiles(files) {
      const selectedFilesDiv = document.getElementById("selected-files");
      if (files.length === 0) {
        selectedFilesDiv.innerHTML = "";
        return;
      }
      const filesList = files.map(file => {
        return `<div class="inline-flex items-center bg-gray-100 text-gray-700 rounded-full px-3 py-1 text-sm m-1">
                  <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                  </svg>
                  ${file.name}
                </div>`;
      }).join("");
      selectedFilesDiv.innerHTML = filesList;
    }

    function uploadFiles(files) {
  const formData = new FormData();
  let totalSize = 0;
  for (let file of files) {
    totalSize += file.size;
    formData.append('files[]', file);
  }
  if (totalSize > 45 * 1024 * 1024) {
    if (!confirm('The total file size is large and may cause issues. Continue?')) {
      return;
    }
  }
  fetch('/upload', {
    method: 'POST',
    body: formData,
    timeout: 300000
  })
  .then(response => {
    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
    return response.json();
  })
  .then(data => {
    console.log("Upload result:", data);
    // Clear the file input after a successful upload
    document.getElementById("file-input").value = "";
    // Also clear the droppedFiles array if needed.
    droppedFiles = [];
  })
  .catch(error => {
    console.error('Upload error:', error);
  });
}


    function fetchPresets() {
      fetch("/presets")
        .then(response => response.json())
        .then(data => {
          if (data.status === "success") {
            const presetSelect = document.getElementById("preset-select");
            presetSelect.innerHTML = '<option value="">-- Choose a preset --</option>';
            data.presets.forEach(preset => {
              const option = document.createElement("option");
              option.value = preset;
              option.textContent = preset;
              presetSelect.appendChild(option);
            });
          } else {
            console.error("Failed to load presets:", data.message);
          }
        })
        .catch(error => console.error("Error fetching presets:", error));
    }

    async function loadPreset(selectedPreset) {
      try {
        const response = await fetch("/presets/load", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ preset: selectedPreset })
        });
        const data = await response.json();
        if (data.status !== "success") throw new Error(data.message);
        return data;
      } catch (error) {
        throw new Error(`Error loading preset: ${error.message}`);
      }
    }

    // Remove the timestamp query parameter from the fetch call.
    async function loadSummaryStatistics() {
      return fetch('/summary_statistics')
        .then(response => {
          if (!response.ok) throw new Error("Failed to load summary statistics.");
          return response.text();
        })
        .then(text => {
          const separator = "\n--------------------------------------------------------------------------------\n";
          let blocks = text.split(separator);
          if (blocks.length > 1) {
            let header = blocks[0].trim();
            let latestBlock = blocks[blocks.length - 1].trim();
            document.getElementById("summary-statistics").textContent =
              header + "\n" + separator.trim() + "\n" + latestBlock;
            
            // Look for a "Last updated:" line (if present) and update the display.
            const match = text.match(/Last updated: (.+)/);
            if (match && match[1]) {
              updateLastUpdated(new Date(match[1]));
            }
          } else {
            document.getElementById("summary-statistics").textContent = text.trim();
          }
        })
        .catch(error => {
          console.error("Error loading summary statistics:", error);
          document.getElementById("summary-statistics").textContent =
            "Error loading summary statistics.";
        });
    }


    function updateButtonStatus(message) {
      const button = document.getElementById("submit-button");
      button.innerHTML = `
        <svg class="inline-block animate-spin -ml-1 mr-3 h-4 w-4 text-white"
             xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" 
                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        ${message}`;
    }

    function pollSystemStatus() {
      const button = document.getElementById("submit-button");
      const interval = setInterval(() => {
        fetch("/current_status")
          .then(response => {
            if (!response.ok) throw new Error("Network response not OK");
            return response.json();
          })
          .then(data => {
            let statusText = data.status;
            if (statusText.toLowerCase().includes("completed")) {
              clearInterval(interval);
              button.disabled = false;
              button.textContent = "Run Analysis";
              showNewResultsAvailable();
            } else {
              updateButtonStatus(statusText);
            }
          })
          .catch(error => console.error("Error polling system status:", error));
      }, 1000);
    }

    async function handleSubmit() {
      const button = document.getElementById("submit-button");
      button.disabled = true;
      const emailCheckbox = document.getElementById('enable-email');
      const emailInput = document.getElementById('email-input');
      const emailValue = emailCheckbox.checked ? emailInput.value.trim() : '';
      
      try {
        if (currentMode === "dataset") {
          const selectedPreset = document.getElementById("preset-select").value;
          if (!selectedPreset) throw new Error("Please select a preset first");
          updateButtonStatus("Loading preset...");
          await loadPreset(selectedPreset);
        }
        
        if (currentMode === "text") {
          const cnfText = document.getElementById("cnf-text-input").value;
          const res = await fetch("/upload_text", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ cnf_text: cnfText })
          });
          const result = await res.json();
          if (result.status !== "success") throw new Error(result.message);
        }

        const res = await fetch("/run", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email: emailValue })
        });
        
        const data = await res.json();
        if (data.status === "success") {
          pollSystemStatus();
          startCheckingResults();
        } else {
          throw new Error(data.message);
        }
      } catch (error) {
        console.error("Error:", error);
        button.disabled = false;
        button.textContent = "Run Analysis";
      }
    }
  </script>
</body>
</html>